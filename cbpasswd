#!/usr/bin/env python

import getpass
import argparse
import sys

import lib.crypto
import lib.cfg

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='Change master password')
    parser.add_argument('-v', '--version', action='version', version='Cryptobox ' + lib.cfg.version)
    parser.parse_args()

    password = getpass.getpass('Current password: ')

    new_password = getpass.getpass('New password: ')
    new_password2 = getpass.getpass('Retype new password: ')

    if new_password != new_password2:
        print "Your passwords don't match!"
        sys.exit(0)

    try:
        lib.cfg.backup()
    except:
        ans = raw_input("Couldn't perform a backup, continue? [y|n]: ")

        if not ans in ['Y', 'y']:
            sys.exit(0)

    conf = lib.crypto.read_cfg(lib.cfg.path_cfg)
    plaintext = lib.crypto.dec_db(conf, password, lib.cfg.path_db, lib.cfg.path_db_hmac)
    lib.crypto.enc_plaintext(conf, new_password, plaintext, lib.cfg.path_db, lib.cfg.path_db_hmac)
